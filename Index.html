<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- ============================================
       モード切り替え方法:
       
       【GASモード】デフォルト
       - そのままGASにデプロイ
       
       【ローカルモード】file://で直接開く場合
       1. 下の「GASモード」行をコメントアウト
       2. 「ローカルモード」行のコメントを解除
       ============================================ -->
  
  <!-- GASモード -->
  <?!= include('Style'); ?>
  
  <!-- ローカルモード（GASモード行をコメントアウトして有効化）
  <link rel="stylesheet" href="Style.css">
  -->
  
</head>
<body>
  <div id="app">
    <!-- ヘッダー -->
    <header class="header">
      <h1 class="header-title">
        <span class="material-icons">style</span>
        GAS フラッシュカード
      </h1>
      <button class="header-btn" onclick="App.showSettings()">
        <span class="material-icons">settings</span>
      </button>
    </header>

    <!-- メインコンテンツ -->
    <main class="main-content">
      <!-- ローディング画面 -->
      <div id="loading-screen" class="screen" style="display: flex;">
        <div class="loading-spinner"></div>
        <p>データを読み込んでいます...</p>
      </div>

      <!-- エラー画面 -->
      <div id="error-screen" class="screen">
        <div class="error-icon">
          <span class="material-icons">error_outline</span>
        </div>
        <h2>エラーが発生しました</h2>
        <p id="error-message"></p>
        <button class="btn btn-primary" onclick="App.retry()">再試行</button>
      </div>

      <!-- ホーム画面 -->
      <div id="home-screen" class="screen">
        <div class="stats-summary">
          <h2>学習状況</h2>
          <div class="stats-grid">
            <div class="stat-card stat-clickable" onclick="App.showTodayStudiedCards()">
              <span class="material-icons">today</span>
              <div class="stat-value" id="stat-today">0</div>
              <div class="stat-label">今日の学習</div>
            </div>
            <div class="stat-card stat-clickable" onclick="App.showCardListWithFilter('all')">
              <span class="material-icons">library_books</span>
              <div class="stat-value" id="stat-total">0 / 0</div>
              <div class="stat-label">学習済み / 全体</div>
            </div>
            <div class="stat-card stat-clickable" onclick="App.showCardListWithFilter('passed')">
              <span class="material-icons">check_circle</span>
              <div class="stat-value" id="stat-passed">0</div>
              <div class="stat-label">合格</div>
            </div>
            <div class="stat-card stat-clickable" onclick="App.showCardListWithFilter('review')">
              <span class="material-icons">schedule</span>
              <div class="stat-value" id="stat-review">0</div>
              <div class="stat-label">復習待ち</div>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-large btn-secondary" onclick="App.startStudy('new')">
            <span class="material-icons">add_circle</span>
            新規学習
            <span class="btn-badge" id="new-count-badge">0</span>
          </button>
          <button class="btn btn-large btn-primary" onclick="App.startStudy('review')">
            <span class="material-icons">quiz</span>
            今日の復習
            <span class="btn-badge" id="review-count-badge">0</span>
          </button>
          <button class="btn btn-large btn-outline" onclick="App.startWeakPointStudy()">
            <span class="material-icons">psychology</span>
            弱点カード
          </button>
          <button class="btn btn-large btn-outline" onclick="App.showStudySettings()">
            <span class="material-icons">school</span>
            学習モード
          </button>
          <button class="btn btn-large btn-outline" onclick="App.showCardList()">
            <span class="material-icons">list_alt</span>
            カード一覧
          </button>
        </div>

        <!-- デバッグ情報（ステップ1用） -->
        <div class="debug-section">
          <h3>デバッグ情報（ステップ1）</h3>
          <div id="debug-info">
            <p>接続状態: <span id="debug-connection">-</span></p>
            <p>カード数: <span id="debug-card-count">-</span></p>
            <p>フィールド数: <span id="debug-field-count">-</span></p>
            <p>デッキ数: <span id="debug-deck-count">-</span></p>
          </div>
          <button class="btn btn-small" onclick="App.showRawData()">生データを表示</button>
          <pre id="debug-raw-data" class="debug-raw"></pre>
        </div>
      </div>

      <!-- 学習画面 -->
      <div id="study-screen" class="screen">
        <!-- 学習ヘッダー -->
        <div class="study-header">
          <button class="btn btn-icon" onclick="App.exitStudy()">
            <span class="material-icons">arrow_back</span>
          </button>
          <div class="study-progress">
            <span id="study-current">1</span> / <span id="study-total">0</span>
          </div>
          <div class="study-actions">
            <button class="btn btn-icon" id="btn-autoplay" onclick="App.toggleAutoPlay()" title="連続再生">
              <span class="material-icons">play_circle</span>
            </button>
            <button class="btn btn-icon" id="btn-repeat" onclick="App.toggleRepeat()" title="リピート">
              <span class="material-icons">repeat</span>
            </button>
            <button class="btn btn-icon" id="btn-speech" onclick="App.speakCurrentCard()" title="読み上げ">
              <span class="material-icons">volume_up</span>
            </button>
            <button class="btn btn-icon" id="btn-favorite" onclick="App.toggleFavorite()">
              <span class="material-icons">star_border</span>
            </button>
            <button class="btn btn-icon" id="btn-passed" onclick="App.togglePassed()">
              <span class="material-icons">check_circle_outline</span>
            </button>
          </div>
        </div>

        <!-- フラッシュカード -->
        <div class="flashcard-container">
          <!-- 次のカード（後ろで待機） -->
          <div class="flashcard-next" id="flashcard-next">
            <div class="flashcard-inner">
              <div class="flashcard-front">
                <div class="card-content" id="next-front-content">
                  <!-- 動的に生成 -->
                </div>
                <div class="card-hint">タップでめくる</div>
              </div>
            </div>
          </div>
          <!-- 現在のカード（手前で表示） -->
          <div class="flashcard" id="flashcard" onclick="App.flipCard()">
            <div class="flashcard-inner">
              <!-- 表面 -->
              <div class="flashcard-front" id="card-front">
                <div class="card-content" id="front-content">
                  <!-- 動的に生成 -->
                </div>
                <div class="card-hint">タップでめくる</div>
              </div>
              <!-- 裏面 -->
              <div class="flashcard-back" id="card-back">
                <div class="card-content" id="back-content">
                  <!-- 動的に生成 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 回答ボタン（裏面表示時のみ） -->
        <div class="answer-buttons" id="answer-buttons" style="display: none;">
          <button class="btn btn-answer btn-hard" onclick="App.answerCard('hard')">
            <span class="material-icons">sentiment_very_dissatisfied</span>
            難しい
          </button>
          <button class="btn btn-answer btn-normal" onclick="App.answerCard('normal')">
            <span class="material-icons">sentiment_neutral</span>
            普通
          </button>
          <button class="btn btn-answer btn-easy" onclick="App.answerCard('easy')">
            <span class="material-icons">sentiment_very_satisfied</span>
            簡単
          </button>
        </div>

        <!-- ナビゲーションボタン -->
        <div class="nav-buttons">
          <button class="btn btn-nav" onclick="App.prevCard()" id="btn-prev">
            <span class="material-icons">chevron_left</span>
            前へ
          </button>
          <button class="btn btn-nav" onclick="App.nextCard()" id="btn-next">
            次へ
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
      </div>

      <!-- 設定画面 -->
      <div id="settings-screen" class="screen">
        <div class="settings-header">
          <button class="btn btn-icon" onclick="App.closeSettings()">
            <span class="material-icons">arrow_back</span>
          </button>
          <h2>設定・統計</h2>
          <div style="width: 40px;"></div>
        </div>
        <div class="settings-content" id="settings-content">
          <!-- 動的に生成 -->
        </div>
      </div>

      <!-- デッキ選択画面は学習設定に統合されました -->

      <!-- 学習設定画面（デッキ選択統合版） -->
      <div id="study-settings-screen" class="screen">
        <div class="settings-header">
          <button class="btn btn-icon" onclick="App.closeStudySettings()">
            <span class="material-icons">arrow_back</span>
          </button>
          <h2>学習設定</h2>
          <div style="width: 40px;"></div>
        </div>

        <!-- デッキ選択（折りたたみ式） -->
        <div class="setting-section">
          <h3 class="collapsible-header" onclick="App.toggleSection(this)">
            <span class="material-icons">folder</span>
            デッキ選択
            <span class="collapse-icon material-icons">expand_more</span>
          </h3>
          <div class="collapsible-content">
            <div class="deck-tree-inline" id="deck-tree-inline">
              <!-- 動的に生成 -->
            </div>
          </div>
        </div>

        <!-- 学習モード -->
        <div class="setting-section">
          <h3>学習モード</h3>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="studyMode" value="all" checked>
              <span class="radio-label">
                <span class="material-icons">shuffle</span>
                全体復習
              </span>
            </label>
            <label class="radio-item">
              <input type="radio" name="studyMode" value="review">
              <span class="radio-label">
                <span class="material-icons">quiz</span>
                今日の復習
              </span>
            </label>
            <label class="radio-item">
              <input type="radio" name="studyMode" value="new">
              <span class="radio-label">
                <span class="material-icons">add_circle</span>
                新規学習
              </span>
            </label>
          </div>
        </div>

        <!-- 学習範囲 -->
        <div class="setting-section">
          <h3>学習範囲</h3>
          <div class="range-inputs">
            <div class="range-input-group">
              <label>開始単語番号</label>
              <input type="number" id="word-start" min="1" placeholder="1">
            </div>
            <div class="range-input-group">
              <label>学習単語数</label>
              <input type="number" id="word-count" min="1" placeholder="全て">
            </div>
          </div>
          <p class="setting-hint">※ 単語番号1 = スプレッドシートの行番号5（空欄で制限なし）</p>
        </div>

        <!-- フィルター -->
        <div class="setting-section">
          <h3>フィルター</h3>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" id="filter-favorite">
              <span class="checkbox-label">
                <span class="material-icons">star</span>
                お気に入りのみ
              </span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" id="filter-not-passed">
              <span class="checkbox-label">
                <span class="material-icons">pending</span>
                未合格のみ
              </span>
            </label>
          </div>
        </div>

        <!-- シャッフル設定 -->
        <div class="setting-section">
          <h3>表示順序</h3>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" id="setting-shuffle" checked>
              <span class="checkbox-label">
                <span class="material-icons">shuffle</span>
                シャッフルする
              </span>
            </label>
          </div>
        </div>

        <!-- プレビュー -->
        <div class="setting-section">
          <h3>対象カード</h3>
          <div class="preview-count" id="preview-count">
            <span class="material-icons">library_books</span>
            <span id="filtered-card-count">0</span>枚のカードが対象です
          </div>
        </div>

        <!-- 開始ボタン -->
        <div class="study-start-actions">
          <button class="btn btn-primary btn-large" onclick="App.startFilteredStudy()">
            <span class="material-icons">play_arrow</span>
            学習開始
          </button>
        </div>
      </div>

      <!-- カード一覧画面 -->
      <div id="card-list-screen" class="screen">
        <div class="settings-header">
          <button class="btn btn-icon" onclick="App.closeCardList()">
            <span class="material-icons">arrow_back</span>
          </button>
          <h2>カード一覧</h2>
          <div style="width: 40px;"></div>
        </div>

        <!-- 検索・フィルター -->
        <div class="card-list-filter">
          <div class="search-box">
            <span class="material-icons">search</span>
            <input type="text" id="card-search" placeholder="検索..." oninput="App.filterCardList()">
          </div>
          <select id="card-list-deck-filter" onchange="App.filterCardList()">
            <option value="">すべてのデッキ</option>
          </select>
        </div>
        
        <!-- フィルターオプション -->
        <div class="card-list-filter-options">
          <div class="filter-group">
            <label>表示:</label>
            <select id="card-list-side-filter" onchange="App.filterCardList()">
              <option value="both">両方</option>
              <option value="front">左（表）のみ</option>
              <option value="back">右（裏）のみ</option>
            </select>
          </div>
          <div class="filter-group">
            <label>お気に入り:</label>
            <select id="card-list-fav-filter" onchange="App.filterCardList()">
              <option value="all">すべて</option>
              <option value="fav">お気に入りのみ</option>
              <option value="not-fav">お気に入り以外</option>
            </select>
          </div>
          <div class="filter-group">
            <label>合格:</label>
            <select id="card-list-pass-filter" onchange="App.filterCardList()">
              <option value="all">すべて</option>
              <option value="passed">合格のみ</option>
              <option value="not-passed">未合格のみ</option>
            </select>
          </div>
        </div>

        <!-- 読み上げ設定 -->
        <div class="card-list-speech-settings">
          <div class="speech-control-group">
            <button class="btn btn-icon speech-control-btn" id="list-autoplay-btn" onclick="App.toggleListAutoPlay()" title="連続再生">
              <span class="material-icons">play_circle</span>
            </button>
            <button class="btn btn-icon speech-control-btn" id="list-repeat-btn" onclick="App.toggleListRepeat()" title="リピート">
              <span class="material-icons">repeat</span>
            </button>
          </div>
          <div class="speech-speed-group">
            <input type="range" id="list-speed-slider" min="0.5" max="2" step="0.1" value="1.0" 
                   oninput="App.updateListSpeed(this.value)" title="再生速度">
            <span id="list-speed-value">1.0x</span>
          </div>
          <div class="speech-lang-group">
            <label>読み上げ:</label>
            <select id="list-speech-lang" onchange="App.setListSpeechLangFilter(this.value)">
              <option value="all">すべて</option>
              <option value="en">英語のみ</option>
              <option value="ja">日本語のみ</option>
            </select>
          </div>
        </div>

        <!-- カード一覧 -->
        <div class="card-list-container" id="card-list-container">
          <!-- 動的に生成 -->
        </div>
      </div>

      <!-- カード編集画面 -->
      <div id="card-edit-screen" class="screen">
        <div class="settings-header">
          <button class="btn btn-icon" onclick="App.closeCardEdit()">
            <span class="material-icons">arrow_back</span>
          </button>
          <h2 id="card-edit-title">カード編集</h2>
          <button class="btn btn-icon" onclick="App.saveCard()">
            <span class="material-icons">save</span>
          </button>
        </div>

        <div class="card-edit-content" id="card-edit-content">
          <!-- 動的に生成 -->
        </div>
      </div>
    </main>

    <!-- フッター -->
    <footer class="footer">
      <p>GAS フラッシュカード v1.0.0</p>
    </footer>
    
    <!-- ローカルモード用: データエクスポートボタン（ローカルモード時のみ表示） -->
    <div id="local-mode-controls" style="display: none;">
      <button class="btn btn-secondary" onclick="DataExporter.exportProgress()" style="position: fixed; bottom: 50px; right: 20px; z-index: 1000;">
        <span class="material-icons">download</span>
        進捗を保存
      </button>
    </div>
  </div>

  <!-- GASモード -->
  <?!= include('data-adapter'); ?>
  <?!= include('Script'); ?>
  
  <!-- ローカルモード（GASモード行をコメントアウトして有効化）
  <script src="data-adapter.js"></script>
  <script src="Script.js"></script>
  -->
  
</body>
</html>
