# フラッシュカードアプリ 仕様書 v1.1

## 1. 概要

### 1.1 アプリケーション名
**GAS フラッシュカード**

### 1.2 目的
Google Apps Script (GAS) と HTML を活用した、英単語学習用のフラッシュカードアプリケーション。
Anki風の間隔反復学習システムを採用し、効率的な暗記学習をサポートする。

### 1.3 技術スタック
| 項目 | 技術 | 詳細 |
|------|------|------|
| バックエンド | Google Apps Script (GAS) | V8ランタイム |
| フロントエンド | HTML / CSS / JavaScript | ES6+ |
| データベース | Google スプレッドシート | 3シート構成 |
| 音声合成 | Web Speech API | SpeechSynthesis |
| UIフレームワーク | カスタムCSS | Material Icons使用 |
| フォント | Google Fonts | Noto Sans JP |

### 1.4 利用者
- 個人利用（共有機能なし）
- Googleアカウント必須

### 1.5 対応環境
| 環境 | 対応状況 |
|------|---------|
| Chrome（PC） | ✅ 推奨 |
| Chrome（Android） | ✅ 対応 |
| Safari（Mac/iOS） | ✅ 対応 |
| Firefox | ✅ 対応 |
| Edge | ✅ 対応 |

---

## 2. システム構成

### 2.1 ファイル構成
```
📁 HTML_GAS_flashcards
  ├── Code.gs              # GASメインコード（サーバーサイド処理）
  ├── Index.html           # メイン画面（HTML構造）
  ├── Style.html           # スタイルシート（CSS）
  ├── Script.html          # クライアントサイドJavaScript
  ├── SPECIFICATION.md     # 本仕様書
  ├── README.md            # セットアップ手順
  └── 開発ステップ計画.md   # 開発進捗管理
```

### 2.2 スプレッドシート構成

#### 2.2.1 スプレッドシートID
```
1i5YCfwU_IJYC-4EWZQsBxIOVczdrJShvInJZGPxmZ0U
```

#### 2.2.2 シート1: Cards（カードデータ）
カードのデータと表示設定を管理するメインシート。

**構造：**
|   | A | B | C | D | E | F | G | H |
|---|---|---|---|---|---|---|---|---|
| 1 | フィールド名 | ID | デッキ | 英語 | 日本語 | 読み | 例文 | 発音記号 |
| 2 | 表示面 | - | - | 表 | 裏 | 裏 | 裏 | 非表示 |
| 3 | 表示順 | - | - | 1 | 1 | 2 | 3 | - |
| 4 | 読上順 | - | - | 1 | 1 | - | - | - |
| 5 | （データ開始） | 1 | TOEIC/基礎 | apple | りんご | アップル | I eat an apple. | ˈæp.əl |
| 6 | | 2 | TOEIC/基礎 | book | 本 | ブック | This is a book. | bʊk |


**行の説明：**
| 行番号 | 内容 | 説明 |
|--------|------|------|
| 1行目 | フィールド名 | 各列のデータ項目名（ヘッダー） |
| 2行目 | 表示面 | 「表」「裏」「非表示」のいずれか |
| 3行目 | 表示順 | 表面・裏面それぞれでの表示順序（数字、小さい順） |
| 4行目 | 読上順 | 読み上げの順序（数字、空欄は読み上げなし） |
| 5行目〜 | カードデータ | 実際のフラッシュカードデータ |

**固定列（A〜B列）：**
| 列 | フィールド名 | 説明 |
|----|-------------|------|
| A | ID | カードの一意識別子（行番号を使用） |
| B | デッキ | カードが属するデッキ（パス形式で階層表現） |

**動的列（C列以降）：**
ユーザーが自由に追加・編集可能。

**読上順の仕様：**
- 表面・裏面それぞれで独立して読み上げ順序を管理
- 表面の読み上げ：表示面=「表」かつ読上順が設定されているフィールド
- 裏面の読み上げ：表示面=「裏」かつ読上順が設定されているフィールド
- 空欄、「-」、「0」は読み上げ対象外

#### 2.2.3 シート2: Progress（学習進捗）
各カードの学習状況を記録するシート。

**構造：**
|   | A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|---|
| 1 | 行番号 | 正解数 | 不正解数 | 連続正解 | 次回復習日 | お気に入り | 合格 |
| 2 | 5 | 3 | 1 | 2 | 2025-12-01 | FALSE | FALSE |
| 3 | 6 | 5 | 0 | 5 | 2025-12-05 | TRUE | TRUE |


**列の説明：**
| 列 | フィールド名 | データ型 | 説明 |
|----|-------------|---------|------|
| A | 行番号 | 数値 | Cardsシートの行番号（5行目〜に対応） |
| B | 正解数 | 数値 | 累計正解回数 |
| C | 不正解数 | 数値 | 累計不正解回数 |
| D | 連続正解 | 数値 | 現在の連続正解数（streak） |
| E | 次回復習日 | 日付 | YYYY-MM-DD形式 |
| F | お気に入り | 真偽値 | TRUE / FALSE |
| G | 合格 | 真偽値 | TRUE / FALSE |

#### 2.2.4 シート3: Settings（アプリ設定）
アプリ全体の設定を保存するシート。

**構造：**
|   | A | B | C |
|---|---|---|---|
| 1 | 設定キー | 設定値 | 説明 |
| 2 | speechRateEn | 2 | 英語読み上げ速度 (0.1〜10) |
| 3 | speechRateJa | 2 | 日本語読み上げ速度 (0.1〜10) |
| 4 | waitTimeBetweenCards | 0 | カード間の待機時間（秒） |
| 5 | waitTimeAfterFlip | 0 | めくり後の待機時間（秒） |
| 6 | interval_1 | 1 | 1回目正解後の復習間隔（日） |
| 7 | interval_2 | 3 | 2回連続正解後の復習間隔（日） |
| 8 | interval_3 | 7 | 3回連続正解後の復習間隔（日） |
| 9 | interval_4 | 14 | 4回連続正解後の復習間隔（日） |
| 10 | interval_5 | 30 | 5回以上連続正解後の復習間隔（日） |


---

## 3. 機能仕様

### 3.1 デッキ管理

#### 3.1.1 ツリー形式のデッキ構造
- デッキは階層構造（ツリー形式）で管理
- 階層数は**無制限**
- パス形式で表現（例：`TOEIC/基礎/レベル1`）
- 区切り文字は `/`（スラッシュ）

**デッキ構造例：**
```
📁 すべてのデッキ（ルート）
  ├── 📁 TOEIC
  │   ├── 📁 基礎
  │   │   ├── 📁 レベル1
  │   │   └── 📁 レベル2
  │   └── 📁 上級
  ├── 📁 英検
  │   ├── 📁 2級
  │   └── 📁 準1級
  └── 📁 日常会話
```

#### 3.1.2 デッキ選択機能
- ツリー形式でデッキ一覧を表示
- 親デッキを選択すると、その配下の全カードが対象
- 「すべてのデッキ」で全カード選択
- 選択中のデッキ名とカード枚数をヘッダーに表示

#### 3.1.3 デッキツリーの操作
- クリックでデッキ選択
- 矢印アイコンで子デッキの展開/折りたたみ
- 選択中のデッキはハイライト表示

### 3.2 フィールド管理

#### 3.2.1 動的フィールド
- フィールド（列）は**スプレッドシートで直接追加・編集**
- アプリは起動時にCardsシートの1行目を読み取り、フィールドを動的に認識
- フィールド数に**制限なし**

#### 3.2.2 表示設定（2行目）
| 設定値 | 動作 |
|--------|------|
| `表` | カードの表面に表示 |
| `裏` | カードの裏面に表示 |
| `非表示` / 空欄 / `-` | 表示しない |

#### 3.2.3 表示順序（3行目）
- 数字が小さい順に表示
- 同じ数字の場合は列順（左から右）
- 空欄は表示対象外

#### 3.2.4 読み上げ順序（4行目）
- 数字が小さい順に読み上げ
- 空欄、`-`、`0` は読み上げ対象外
- **表面と裏面で別々に読み上げ**（表面の読み上げ中は表面フィールドのみ）

### 3.3 カード表示

#### 3.3.1 カード遷移アニメーション
```
[現在のカード] ─→ 左へスライドアウト (400ms)
       ↓
[次のカード]  ←─ 後ろで待機していた次のカードが露出
```

- 次のカードは現在のカードの後ろで事前に待機
- 現在のカードが左へスライドアウト
- スライドアウト完了と同時に次のカードが見える状態になる
- スライドイン不要のため、即座に次の学習を開始可能
- これにより次カードの裏面が見えない

#### 3.3.2 カードめくりアニメーション
- 3D回転アニメーション（Y軸で180度回転）
- アニメーション時間：0.6秒
- タップ/クリックでめくり

#### 3.3.3 フラッシュカード画面構成
```
┌─────────────────────────────────────┐
│ [←] 進捗 1/10  [▶][↻][🔊][★][✓]   │  ← ヘッダー
├─────────────────────────────────────┤
│                                     │
│           ┌───────────────┐         │
│           │               │         │
│           │    apple      │         │  ← カード（表面）
│           │               │         │
│           │ [タップでめくる] │         │
│           └───────────────┘         │
│                                     │
├─────────────────────────────────────┤
│   [✗ 不正解]         [○ 正解]      │  ← 回答ボタン
├─────────────────────────────────────┤
│   [← 前へ]           [次へ →]      │  ← ナビゲーション
└─────────────────────────────────────┘
```

#### 3.3.4 ヘッダーボタン
| ボタン | アイコン | 機能 |
|--------|---------|------|
| 戻る | arrow_back | 学習終了してホームへ |
| 連続再生 | play_circle / pause_circle | 連続再生ON/OFF |
| リピート | repeat | リピートモードON/OFF |
| 読み上げ | volume_up / stop | 現在の面を読み上げ/停止 |
| お気に入り | star_border / star | お気に入り登録/解除 |
| 合格 | check_circle_outline / check_circle | 合格マーク設定/解除 |

### 3.4 読み上げ機能

#### 3.4.1 言語自動判別
読み上げ言語は以下の優先順位で判定：

1. **フィールド名から判定**
   - 「英語」「English」「en」を含む → 英語（en-US）
   - 「日本語」「Japanese」「ja」「読み」「例文」を含む → 日本語（ja-JP）

2. **テキスト内容から判定**
   - ひらがな・カタカナ・漢字を含む → 日本語
   - それ以外 → 英語

#### 3.4.2 読み上げ速度設定
| 設定キー | 範囲 | デフォルト | 説明 |
|---------|------|-----------|------|
| speechRateEn | 0.1〜10 | 2.0 | 英語読み上げ速度 |
| speechRateJa | 0.1〜10 | 2.0 | 日本語読み上げ速度 |

#### 3.4.3 単体読み上げ
- 読み上げボタン（🔊）をタップ
- 現在表示中の面（表/裏）のフィールドを読上順に読み上げ
- 読み上げ中は再度タップで停止

#### 3.4.4 連続再生モード
```
1. 連続再生ボタン（▶）をタップしてON
2. 表面のフィールドを読上順に読み上げ
3. waitTimeAfterFlip秒 待機
4. 自動で裏面にめくる
5. waitTimeAfterFlip秒 待機
6. 裏面のフィールドを読上順に読み上げ
7. waitTimeBetweenCards秒 待機
8. 次のカードへスライドアニメーション
9. 2に戻る
```

#### 3.4.5 リピートモード
- 連続再生と併用
- 最後のカードに達したら最初に戻る
- 手動で停止するまでループ

#### 3.4.6 待機時間設定
| 設定キー | デフォルト | 説明 |
|---------|-----------|------|
| waitTimeAfterFlip | 0秒 | めくり前後の待機時間 |
| waitTimeBetweenCards | 0秒 | カード間の待機時間 |

**注意：** 負の値を設定した場合は0として扱われます。

### 3.5 学習モード

#### 3.5.1 モード一覧
| モード | 説明 | 対象カード |
|--------|------|-----------|
| 今日の復習 | 復習期日のカード | nextReviewDate ≤ 今日 かつ 未合格 |
| 新規学習 | 未学習カード | correctCount = 0 かつ incorrectCount = 0 |
| 全体復習 | 全カード | 選択デッキ内すべて |

#### 3.5.2 絞り込み機能
| 条件 | 設定方法 | 説明 |
|------|---------|------|
| 開始単語番号 | 数値入力 | 単語番号1 = スプレッドシート5行目 |
| 学習単語数 | 数値入力 | 開始位置からの単語数 |
| お気に入りのみ | チェックボックス | favorite = TRUE のみ |
| 未合格のみ | チェックボックス | passed ≠ TRUE のみ |
| シャッフル | チェックボックス | カード順序をランダム化 |

**絞り込みの適用順序：**
1. デッキフィルター
2. 単語番号でソート（行番号順）
3. 範囲フィルター（開始番号〜単語数）
4. 学習モードフィルター
5. お気に入りフィルター
6. 未合格フィルター
7. シャッフル（オプション）

### 3.6 間隔反復学習（スペースドリピティション）

#### 3.6.1 復習間隔の仕組み
| 連続正解数 | 次回復習までの日数 | 設定キー |
|-----------|-------------------|---------|
| 0回（不正解時） | 連続正解リセット | - |
| 1回 | 1日後 | interval_1 |
| 2回 | 3日後 | interval_2 |
| 3回 | 7日後 | interval_3 |
| 4回 | 14日後 | interval_4 |
| 5回以上 | 30日後 | interval_5 |

#### 3.6.2 回答の再記録機能
同じセッション内で同じカードに再度回答した場合：
1. 前回の回答を取り消し（正解/不正解カウントを元に戻す）
2. 新しい回答を記録
3. これにより「正解」→「不正解」の変更でも正確なカウントを維持

### 3.7 進捗管理

#### 3.7.1 カード別進捗
| 項目 | 説明 |
|------|------|
| correctCount | 累計正解回数 |
| incorrectCount | 累計不正解回数 |
| streak | 連続正解数（不正解でリセット） |
| nextReviewDate | 次回復習日 |
| favorite | お気に入りフラグ |
| passed | 合格フラグ |

#### 3.7.2 ホーム画面の統計表示
| 統計項目 | 計算方法 |
|---------|---------|
| 今日の学習 | （今後実装予定） |
| 学習済み / 全体 | 正解or不正解が1以上のカード / 全カード |
| 合格 | passed = TRUE のカード数 |
| 復習待ち | nextReviewDate ≤ 今日 かつ passed ≠ TRUE |

### 3.8 お気に入り・合格機能

#### 3.8.1 お気に入り
- 学習画面で ★ ボタンをタップ
- 即座にサーバーに保存
- 「お気に入りのみ」で絞り込み可能

#### 3.8.2 合格マーク
- 学習画面で ✓ ボタンをタップ
- 合格カードは「今日の復習」対象から除外
- 「未合格のみ」で絞り込み可能

---

## 4. 画面仕様

### 4.1 画面一覧
| 画面ID | 画面名 | 説明 | 実装状況 |
|--------|--------|------|---------|
| loading-screen | ローディング | データ読み込み中表示 | ✅ 完了 |
| error-screen | エラー | エラー表示・再試行 | ✅ 完了 |
| home-screen | ホーム | 統計サマリー・学習開始 | ✅ 完了 |
| deck-screen | デッキ選択 | ツリー形式デッキ選択 | ✅ 完了 |
| study-settings-screen | 学習設定 | モード・絞り込み設定 | ✅ 完了 |
| study-screen | 学習画面 | フラッシュカード表示 | ✅ 完了 |
| settings-screen | 設定画面 | アプリ全体設定 | ⏳ 未実装 |
| stats-screen | 統計画面 | 詳細統計・グラフ | ⏳ 未実装 |

### 4.2 画面遷移図
```
                        ┌──────────────┐
                        │   Loading    │
                        └──────┬───────┘
                               │
                        ┌──────▼───────┐
           ┌───────────►│     Home     │◄───────────┐
           │            └──────┬───────┘            │
           │                   │                    │
           │     ┌─────────────┼─────────────┐      │
           │     │             │             │      │
           │     ▼             ▼             ▼      │
      ┌────┴─────────┐  ┌────────────┐  ┌──────────┴──┐
      │  Deck Select │  │  Settings  │  │    Stats    │
      └──────┬───────┘  └────────────┘  └─────────────┘
             │
             ▼
      ┌─────────────┐
      │Study Settings│
      └──────┬───────┘
             │
             ▼
      ┌─────────────┐
      │    Study    │────────► 学習完了 ────►
      └─────────────┘
```

### 4.3 レスポンシブ対応
| 画面幅 | レイアウト |
|--------|-----------|
| 〜599px | 1カラム、タッチ最適化 |
| 600px〜 | 統計4カラム、ボタン横並び |

---

## 5. API仕様（GAS関数）

### 5.1 メインエントリーポイント
```javascript
doGet()
```
- HTMLページを返却
- `Index.html` をテンプレートとして使用
- `Style.html`、`Script.html` をインクルード

### 5.2 データ取得
```javascript
getInitialData()
```
**戻り値：**
```javascript
{
  fields: [
    {
      name: "英語",
      displaySide: "表",
      displayOrder: "1",
      speechOrder: "1"
    },
    // ...
  ],
  cards: [
    {
      rowNumber: 5,
      fields: {
        "ID": "1",
        "デッキ": "TOEIC/基礎",
        "英語": "apple",
        "日本語": "りんご",
        // ...
      }
    },
    // ...
  ],
  progress: {
    "5": {
      correctCount: 3,
      incorrectCount: 1,
      streak: 2,
      nextReviewDate: "2025-12-01",
      favorite: false,
      passed: false
    },
    // ...
  },
  settings: {
    speechRateEn: "2",
    speechRateJa: "2",
    waitTimeBetweenCards: "0",
    waitTimeAfterFlip: "0",
    interval_1: "1",
    // ...
  },
  decks: {
    tree: {
      "TOEIC": {
        "_children": {
          "基礎": {
            "_children": {}
          }
        }
      }
    },
    list: ["TOEIC", "TOEIC/基礎", ...]
  }
}
```

### 5.3 進捗保存
```javascript
saveProgress(rowNumber, progressData)
```
**引数：**
| 引数 | 型 | 説明 |
|-----|---|------|
| rowNumber | Number | Cardsシートの行番号 |
| progressData | Object | 進捗データ |

**progressData構造：**
```javascript
{
  correctCount: 3,
  incorrectCount: 1,
  streak: 2,
  nextReviewDate: "2025-12-01",
  favorite: false,
  passed: false
}
```

### 5.4 内部関数
| 関数名 | 説明 |
|--------|------|
| include(filename) | HTMLテンプレートのインクルード |
| initializeAllSheets() | 初期シート作成 |
| getCards() | カードデータ取得 |
| getProgress() | 進捗データ取得 |
| getSettings() | 設定データ取得 |
| buildDeckTree(cards) | デッキツリー構築 |
| calculateNextReviewDate(streak) | 次回復習日計算 |

---

## 6. クライアントサイド仕様

### 6.1 グローバル状態（AppState）
```javascript
const AppState = {
  // データ
  fields: [],           // フィールド定義配列
  cards: [],            // カードデータ配列
  progress: {},         // 進捗データ（行番号をキーとするオブジェクト）
  settings: {},         // 設定データ
  decks: { tree: {}, list: [] },  // デッキ情報
  
  // UI状態
  isLoading: true,
  error: null,
  selectedDeck: null,   // 選択中デッキパス（null=全デッキ）
  
  // 学習状態
  study: {
    mode: null,         // 'review' | 'new' | 'all' | 'filtered'
    cards: [],          // 学習対象カード配列
    currentIndex: 0,    // 現在のカードインデックス
    isFlipped: false,   // カードめくり状態
    sessionAnswers: {}, // セッション内の回答記録
    isSpeaking: false,  // 読み上げ中フラグ
    isAutoPlay: false,  // 連続再生モード
    isRepeat: false     // リピートモード
  }
};
```

### 6.2 主要関数一覧

#### 初期化・データ
| 関数 | 説明 |
|------|------|
| App.init() | アプリ初期化 |
| App.loadInitialData() | サーバーからデータ読み込み |
| App.onDataLoaded(data) | データ読み込み成功時 |
| App.onDataError(error) | データ読み込み失敗時 |

#### 画面制御
| 関数 | 説明 |
|------|------|
| App.showScreen(screenId) | 画面切り替え |
| App.showDeckSelect() | デッキ選択画面表示 |
| App.showStudySettings() | 学習設定画面表示 |

#### 学習機能
| 関数 | 説明 |
|------|------|
| App.startStudy(mode) | 学習開始 |
| App.startFilteredStudy() | 絞り込み学習開始 |
| App.renderCard() | カード描画 |
| App.flipCard() | カードめくり |
| App.answerCard(isCorrect) | 回答記録 |
| App.prevCard() | 前のカードへ |
| App.nextCard() | 次のカードへ |
| App.slideToCard(index, direction) | スライドアニメーション遷移 |

#### 読み上げ機能
| 関数 | 説明 |
|------|------|
| App.speakCurrentCard() | 現在の面を読み上げ（手動） |
| App.speakCurrentSide(onComplete) | 面の読み上げ（コールバック付き） |
| App.speakSequence(items, index, onComplete) | 順次読み上げ |
| App.speak(text, lang, onEnd) | テキスト読み上げ |
| App.stopSpeech() | 読み上げ停止 |
| App.detectLanguage(fieldName, text) | 言語判定 |

#### 連続再生
| 関数 | 説明 |
|------|------|
| App.toggleAutoPlay() | 連続再生切替 |
| App.toggleRepeat() | リピート切替 |
| App.startAutoPlay() | 連続再生開始 |
| App.autoPlayNextCard() | 連続再生で次カードへ |
| App.slideToCardForAutoPlay(index, direction, onComplete) | 連続再生用スライド |

---

## 7. CSS設計

### 7.1 カラーパレット
| 用途 | 色 | コード |
|------|---|--------|
| プライマリ | 青 | #4285f4 |
| セカンダリ | 緑 | #34a853 |
| 警告 | 赤 | #ea4335 |
| お気に入り | 黄 | #fbbc04 |
| 背景 | 薄灰 | #f5f5f5 |
| テキスト | 濃灰 | #333 |

### 7.2 ボタン状態
| クラス | 効果 |
|--------|------|
| .active | お気に入りON（黄色） |
| .passed | 合格（緑色） |
| .speaking | 読み上げ中（青色パルス） |
| .autoplay-active | 連続再生ON（緑色） |
| .repeat-active | リピートON（黄色） |

### 7.3 カードアニメーション
| クラス | 効果 |
|--------|------|
| .flipped | 180度Y軸回転 |
| .slide-out-left | 左へスライドアウト |
| .slide-out-right | 右へスライドアウト |
| .slide-in-right | 右からスライドイン準備 |
| .slide-in-left | 左からスライドイン準備 |
| .slide-in-active | スライドイン実行 |
| .answer-correct | 正解フィードバック（拡大） |
| .answer-incorrect | 不正解フィードバック（振動） |

---

## 8. 初期データ

### 8.1 初期フィールド設定
| 列 | フィールド名 | 表示面 | 表示順 | 読上順 |
|----|-------------|--------|--------|--------|
| A | ID | - | - | - |
| B | デッキ | - | - | - |
| C | 英語 | 表 | 1 | 1 |
| D | 日本語 | 裏 | 1 | 1 |
| E | 読み | 裏 | 2 | - |
| F | 例文 | 裏 | 3 | - |
| G | 発音記号 | 非表示 | - | - |

### 8.2 サンプルカード
| 行 | デッキ | 英語 | 日本語 | 読み | 例文 |
|----|--------|------|--------|------|------|
| 5 | サンプル | apple | りんご | アップル | I eat an apple. |
| 6 | サンプル | book | 本 | ブック | This is a book. |
| 7 | サンプル | cat | 猫 | キャット | The cat is sleeping. |

---

## 9. 更新履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0.0 | 2025-11-28 | 初版作成 |
| 1.1.0 | 2025-11-28 | 仕様書完全版更新（実装状況反映） |

---

## 10. 制限事項・既知の問題

### 10.1 現在の制限
- カードの追加・編集はスプレッドシートで直接行う
- 画像フィールド未対応
- 複数ユーザー未対応
- オフライン動作未対応

### 10.2 既知の問題
- Web Speech APIはブラウザにより音声が異なる
- 一部のモバイルブラウザでは連続読み上げが途切れる場合がある

### 10.3 今後の実装予定
- [ ] ステップ8: 統計表示の強化
- [ ] ステップ9: 設定画面
- [ ] ステップ10: 最終調整・デバッグ情報削除

---

*本仕様書は開発の基準となるドキュメントです。変更がある場合は本仕様書を更新してください。*
